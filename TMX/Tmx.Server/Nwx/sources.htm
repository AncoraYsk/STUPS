<!DOCTYPE html>
<html>
	<head>
        <script src="../scripts/jquery-2.1.1.min.js"></script>
		<script>
			var sleep;
			sleep = function(ms) {
				var start, _results;
				start = new Date().getTime();
				while (new Date().getTime() - start < ms) {
					continue;
				}
			};
			
			function getServerUrl() {
				// example "http://server:333/folder/file.htm";
				var urlPattern = /http\:\/\/[\w\.\-^\:]+[^\/]+?/i;
				// document.write(window.location);
				// document.write(document.URL);
				return urlPattern.exec(window.location);
			}
			
			function getSourceName() {
				var combo = document.getElementById("src");
				return combo.options[combo.selectedIndex].text;
			}
			
			function setSource() {
				var url = getServerUrl() + "/data/";
				var data = new FormData();
				data.append('key', "sourceName");
				data.append('value', getSourceName());
				var xhr = new XMLHttpRequest();
				xhr.open('POST', url, false);
				xhr.send(data);
			}
			
			function resetTasks() {
				var url = getServerUrl() + "/serverControl/";
				var data = new FormData();
				data.append('command', 4);
				var xhr = new XMLHttpRequest();
				xhr.open('PUT', url, false);
				xhr.send(data);
				var data = new FormData();
				data.append('command', 5);
				var xhr = new XMLHttpRequest();
				xhr.open('PUT', url, false);
				xhr.send(data);
			}
			
			function loadWorkflow() {
				var url = getServerUrl() + "/serverControl/";
				var data = new FormData();
				data.append('command', 0);
				data.append('data', 'data\\workflow.xml');
				var xhr = new XMLHttpRequest();
				xhr.open('PUT', url, false);
				xhr.send(data);
			}
			
			function showLinkToReport() {
				// 
			}
			
			function storeReportToDatabase() {
				// 
			}
			
			function disableButton() {
				document.getElementById("run").disabled = true;
			}
			
			function enableButton() {
				document.getElementById("run").disabled = false;
			}
			
			function checkReportFile() {
				var url = "../Nwx/report.htm";
				var xhr = new XMLHttpRequest();
				xhr.open('GET', url, false);
				xhr.onreadystatechange = function() {
					if (xhr.readyState == 4) {
						if(xhr.status == 200) {
							xhr.status;
							xhr.getAllResponseHeaders();
							xhr.responseText;
							var result = JSON.parse(xhr.response);
							if (0 == result[0].status) {
								return true;
							}
						}
					}
				}
				xhr.addEventListener("loadend", loadEnd, false);
                
                function loadEnd(e) {
                    // alert("The transfer finished (although we don't know if it succeeded or not).");
                    location.href = url;
                }
                xhr.send(null);
			}
			
			function waitReportFile() {
				do {
					sleep(1000);
				} while (!checkReportFile())
			}
			
			function initServer() {
				disableButton();
				setSource();
				resetTasks();
				loadWorkflow();
				// showLinkToReport();
				storeReportToDatabase();
				enableButton();
				checkReportFile();
				// location.href = "../Nwx/report.htm";
				/*
				$.ajax({
                    url: "../Nwx/report.htm",
                    type: 'HEAD',
                    async: false,
                    success: function(data){
                        // alert('exists');
                        location.href = "../Nwx/report.htm";
                    },
                    error: function(data){
                        alert('does not exist');
                    },
                });
                */
                // location.href = "../Nwx/report.htm";
			}
		</script>
	</head>
	<body>
		<b>Please select branch</b><br>
		<select id="src">
			<option value="src01">source 01</option>
			<option value="src02">source 02</option>
			<option value="src03">source 03</option>
			<option value="src04">source 04</option>
		</select>
		<br><b>Run tests for the brach you selected</b><br>
		<button id="run" type="button" onclick="initServer()">Run</button>
        <br>
        <hr>
        <!-- <iframe id="report" src="../Nwx/report.htm" frameborder="0"> -->
            
        </iframe>
	</body>
</html>